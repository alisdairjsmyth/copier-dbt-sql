name: Label PR(s) when a release is published

on:
  release:
    types: [published]   # fires when a draft is published or a release is directly published

permissions:
  contents: read            # checkout/tag resolution
  pull-requests: read       # read PR metadata
  issues: write             # add labels to PR (PRs use Issues API)

jobs:
  label-associated-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Check out the released tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}  # tag the release points to

      - name: Resolve commit SHA of tag
        id: sha
        run: echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Find PR(s) for commit
        id: prs-for-commit
        uses: actions/github-script@v7
        with:
            script: |
                const {owner, repo} = context.repo;
                const sha = steps.sha.outputs.sha;
                const res = await github.request('GET /repos/{owner}/{repo}/commits/{ref}/pulls', {
                    owner, repo, ref: sha
                });
                const numbers = res.data.map(pr => pr.number);
                core.setOutput('numbers', JSON.stringify(numbers));

      - name: Add label to PR
        if: ${{ steps.prs-for-commit.outputs.numbers != '' }}
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          number: ${{ steps.prs-for-commit.outputs.numbers }}
          labels: "autorelease: published"

      - name: Remove label from PR
        if: ${{ steps.prs-for-commit.outputs.numbers != '' }}
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          number: ${{ steps.prs-for-commit.outputs.numbers }}
          labels: "autorelease: tagged"
