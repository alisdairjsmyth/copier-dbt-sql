name: PR

on:
  pull_request:
    types: [edited, opened, reopened, synchronize]
    branches: [master]

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  check-title:
    runs-on: ubuntu-latest

    name: Check PR title

    steps:
      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Check PR title
        run: |
          uvx --from=commitizen cz check --message "${{ github.event.pull_request.title }}"

  deploy-to-dev:
    runs-on: ubuntu-latest
    environment: dev
    env:
      BUNDLE_VAR_budget_policy_id: ${{ vars.BUNDLE_VAR_BUDGET_POLICY_ID }}
      BUNDLE_VAR_warehouse_name: ${{ vars.BUNDLE_VAR_WAREHOUSE_NAME }}
      DATABRICKS_HOST: ${{ vars.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref}}

      - uses: databricks/setup-cli@main
        with:
          version: "[[ databricks_cli_dependency ]]"

      - name: Validate Bundle
        run: databricks bundle validate --target dev

      - name: Deploy Bundle to Development
        run: databricks bundle deploy --target dev

  sqlfluff-lint:
    name: Lint dbt project using SQLFluff
    runs-on: ubuntu-latest
    environment: dev
    env:
      ANNOTATIONS_FILE: ./annotations.json
      DATABRICKS_HOST: ${{ vars.DATABRICKS_HOST }}
      DATABRICKS_HTTP_PATH: ${{ vars.DATABRICKS_HTTP_PATH }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
      DBT_PROFILES_DIR: ./ci_cd
    steps:
      - name: Checkoput with full history
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref}}
          fetch-depth: 0

      - name: Fetch base branch
        run: |
          git fetch origin "${{ github.base_ref }}"

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version-file: "pyproject.toml"

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: |
          uv sync --locked --all-extras --dev

      - name: Check dbt connection
        run: |
          source .venv/bin/activate
          dbt debug
          dbt deps

      - name: Get changed files
        id: get_file_changes
        shell: bash
        run: |
          set -euo pipefail

          # Show context
          echo "Base ref: ${{ github.base_ref }}"
          echo "Head ref: ${{ github.head_ref }}"

          # List files changed between base...HEAD in the PR
          mapfile -t FILES_ALL < <(git diff --name-only --diff-filter=ACMR "origin/${{ github.base_ref }}"...HEAD)

          # Join as space-separated
          FILES_SPC=$(printf './%s ' "${FILES_ALL[@]}")

          # Export outputs for subsequent steps
          {
            echo "files_modified=${FILES_SPC% }"
            echo "files_all<<EOF"
            printf '%s\n' "${FILES_ALL[@]}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Get new and changed .sql files in ./src/models to lint
        id: get_files_to_lint
        shell: bash
        run: |
          set -euo pipefail
          files=$(
            printf '%s\n' ${{ steps.get_file_changes.outputs.files_modified }} \
              | tr -s ' ' '\n' \
              | grep -E '^(\./)?src/models/.*\.sql$' \
              | sort -u \
              || true
          )
          {
            echo "lintees<<EOF"
            printf '%s\n' "$files"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Lint dbt models
        if: steps.get_files_to_lint.outputs.lintees != ''
        shell: bash
        run: |
          source .venv/bin/activate
          # Read multiline output and pass to sqlfluff via xargs
          echo "${{ steps.get_files_to_lint.outputs.lintees }}" \
            [% raw %]| grep -v '^[[:space:]]*$' \[% endraw %]
            | xargs -r sqlfluff lint \
              --templater dbt \
              --format github-annotation \
              --annotation-level failure \
              --nofail \
              --write-output "$ANNOTATIONS_FILE" || true

      - name: Check for annotations
        id: check_annotations
        if: steps.get_files_to_lint.outputs.lintees != ''
        shell: bash
        run: |
          set -euo pipefail
          has_annotations=false
          if [ -s "$ANNOTATIONS_FILE" ] && (
            command -v jq >/dev/null 2>&1 && jq -e 'type=="array" and length>0' "$ANNOTATIONS_FILE" >/dev/null 2>&1
          ); then
            has_annotations=true
          fi
          echo "has_annotations=${has_annotations}" >> "$GITHUB_OUTPUT"

      - name: Show annotations file contents
        shell: bash
        if: steps.get_files_to_lint.outputs.lintees != ''
        run: |
          echo "----- Debug: Checking $ANNOTATIONS_FILE -----"

          if [ ! -f "$ANNOTATIONS_FILE" ]; then
            echo "$ANNOTATIONS_FILE does NOT exist."
            exit 0
          fi

          echo "----- Raw file contents -----"
          cat "$ANNOTATIONS_FILE" | head -c 1000000 || true

          echo "----- Attempt JSON pretty-print -----"
          jq . "$ANNOTATIONS_FILE" || echo "(File is not valid JSON)"

      - name: Annotate
        if: steps.check_annotations.outputs.has_annotations == 'true'
        uses: yuzutech/annotations-action@v0.3.0
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          title: "SQLFluff Lint"
          input: "${{ env.ANNOTATIONS_FILE }}"
          ignore-missing-file: false
