[build-system]  # https://docs.astral.sh/uv/concepts/build-backend/
requires = ["uv_build>=0.9.18,<0.10.0"]
build-backend = "uv_build"

[project]  # https://packaging.python.org/en/latest/specifications/pyproject-toml/
name = "[[ project_name_kebab_case ]]"
version = "0.0.0" # x-release-please-version
description = "Data Product: [[ project_name ]]"
readme = "README.md"
requires-python = ">=3.12,<3.13"
dependencies = [
  "[[ dbt_databricks_dependency ]]",
]

[project.urls]  # https://packaging.python.org/en/latest/specifications/well-known-project-urls/#well-known-labels
#homepage = "[[ project_url ]]"
#source = "[[ project_url ]]"

[dependency-groups]  # https://docs.astral.sh/uv/concepts/projects/dependencies/#development-dependencies
dev = [
  "commitizen>=4.3.0,<5.0.0",
  "databricks-connect>=17.0.0, <18.0.0",
  "pip-system-certs==5.3",
  "pre-commit>=4.5.0, <5.0.0",
  "ruff>=0.14.0, <1.0.0",
  "shandy-sqlfmt[jinjafmt]>=0.28.0, <1.0.0",
  "sqlfluff[rs]>=4.0.0, <4.1.0",
  "sqlfluff-templater-dbt>=4.0.0, <4.1.0",
]

# --- SQLFluff Configuration ---
# Per dbtonic linting rules - https://docs.getdbt.com/docs/cloud/dbt-cloud-ide/lint-format#configure-dbtonic-linting-rules
# Updates for sqlfmt compatibility - https://sqlfmt.com/docs/integrations/sqlfluff
[tool.sqlfluff.core]
templater = "jinja"
dialect = "databricks"
max_line_length = 88
# Included to be compatible with sqlfmt
exclude_rules = [
    "layout.indent",
    "layout.cte_bracket",
    "layout.keyword_newline",
    "layout.select_targets",
    "layout.spacing"
]
ignore_paths = [
  ".databricks/",
  ".github/",
  ".venv/",
  "dbt_packages/",
  "logs/",
  "resources/",
  "macros/",
  "target/"
]

[tool.sqlfluff.templater.dbt]
project_dir = "."
dbt_skip_compilation_error = false

[tool.sqlfluff.templater.jinja]
apply_dbt_builtins = true

[tool.sqlfluff.templater.jinja.macros]
# Macros provided as builtins for dbt projects
dbt_ref = "{% macro ref(model_ref) %}{{model_ref}}{% endmacro %}"
dbt_source = "{% macro source(source_name, table) %}{{source_name}}_{{table}}{% endmacro %}"
dbt_config = "{% macro config() %}{% for k in kwargs %}{% endfor %}{% endmacro %}"
dbt_var = "{% macro var(variable, default='') %}item{% endmacro %}"
dbt_is_incremental = "{% macro is_incremental() %}True{% endmacro %}"

# Aliasing bundle (AL) configuration
[tool.sqlfluff.rules.aliasing.expression]
allow_scalar = false

[tool.sqlfluff.rules.aliasing.length]
min_alias_length = 4

# Ambiguous bundle (AM) configuration
[tool.sqlfluff.rules.ambiguous.column_references]
group_by_and_order_by_style = "implicit"

# Capitalisation bundle (CP) configuration
[tool.sqlfluff.rules.capitalisation.keywords]
capitalisation_policy = "lower"

[tool.sqlfluff.rules.capitalisation.identifiers]
extended_capitalisation_policy = "lower"

[tool.sqlfluff.rules.capitalisation.functions]
capitalisation_policy = "lower"

[tool.sqlfluff.rules.capitalisation.literals]
capitalisation_policy = "lower"

[tool.sqlfluff.rules.capitalisation.types]
capitalisation_policy = "lower"

# Convention bundle (CV)
[tool.sqlfluff.rules.convention.not_equal]
# Require != over <> for not equal
preferred_not_equal_style = "c_style"

[tool.sqlfluff.rules.convention.select_trailing_comma]
select_clause_trailing_comma = "forbid"

# Included to be compatible with sqlfmt
[tool.sqlfluff.rules.convention.terminator]
multiline_newline = true

[tool.sqlfluff.rules.convention.blocked_words]
# Comma separated list of blocked words that should not be used
blocked_words = "concat"

[tool.sqlfluff.rules.convention.quoted_literals]
# Consistent usage of preferred quotes for quoted literals
preferred_quoted_literal_style = "single_quotes"

[tool.sqlfluff.rules.convention.casting_style]
# SQL type casting
preferred_type_casting_style = "shorthand"

# --- sqlfmt Configuration ---
[tool.sqlfmt]
line_length = 88
exclude = ["target/**/*", "dbt_packages/**/*"]

# --- Ruff Configuration ---
[tool.ruff]  # https://docs.astral.sh/ruff/settings/
src = ["src", "tests"]
target-version = "py311"

[tool.ruff.format]  # https://docs.astral.sh/ruff/settings/#format
docstring-code-format = true

[tool.ruff.lint]  # https://docs.astral.sh/ruff/settings/#lint
ignore = [
    "D100", # Missing docstring in public module (annoying for notebooks)
    "D104", # Missing docstring in public package
    "PLR0913", # Too many arguments in function (common in Spark/dbt wrappers)
]

[tool.ruff.lint.isort]  # https://docs.astral.sh/ruff/settings/#lintisort
# Ensure Spark-related imports are grouped together
known-first-party = ["pyspark", "delta"]

[tool.ruff.lint.pycodestyle]  # https://docs.astral.sh/ruff/settings/#lintpycodestyle
max-doc-length = 100

# --- Commitizen Configuration ---
[tool.commitizen]  # https://commitizen-tools.github.io/commitizen/config/configuration_file/
version_provider = "uv"
tag_format = "${version}"
version_files = [
  "pyproject.toml:version",
]
